#!/usr/bin/env sh
# tries to checkout a branch
# if it fails due to worktree existing, cds into it
# supports `-` to go back to the previous worktree

set -e

__git_checkout_wt_path() {
  echo "$1" | sed -n "s/.*is already used by worktree at '\(.*\)'/\1/p"
}

__git_checkout_display_path() {
  case "$1" in
    "$HOME/Developer/"*) echo "${1#$HOME/Developer/}" ;;
    "$HOME/"*) echo "${1#$HOME/}" ;;
    *) echo "$1" ;;
  esac
}

__git_checkout_state_file() {
  echo "$(git rev-parse --git-common-dir)/CHECKOUT_PREVIOUS"
}

if [ $# -eq 0 ]; then
  echo "[git]: arguments required" >&2
  exit 1
fi

# Handle "-" to go back to previous worktree/branch
if [ "$1" = "-" ] && [ $# -eq 1 ]; then
  _prev=$(cat "$(__git_checkout_state_file)" 2>/dev/null || echo "")
  _curr=$(git rev-parse --show-toplevel 2>/dev/null || echo "")

  if [ -n "$_prev" ] && [ -d "$_prev" ] && [ "$_prev" != "$_curr" ]; then
    # save current worktree so the next `-` swaps back
    echo "$_curr" > "$(__git_checkout_state_file)"
    echo "[git]: cd'ing back to $(__git_checkout_display_path "$_prev")" >&2
    echo "$_prev"
    exit 0
  fi

  # same worktree or no previous â€” fall through to regular git checkout -
fi

# save current worktree before checkout so `-` can return here
git rev-parse --show-toplevel > "$(__git_checkout_state_file)" 2>/dev/null || true

checkout_output=$(git checkout "$@" 2>&1) && {
  echo "$checkout_output"
  exit 0
}

# we get here in case of error
# try to extract any existing worktree path from the error
worktree_path=$(__git_checkout_wt_path "$checkout_output")

case "$worktree_path" in
  # no worktree error, bypass it
  "")
    echo "$checkout_output" >&2
    exit 1
    ;;

  # inside developer, print a formatted version of it
  "$HOME/Developer/"*) display_path="${worktree_path#$HOME/Developer/}" ;;

  # not in our usually path, make it clear
  "$HOME/"*) display_path="${worktree_path#$HOME/}" ;;

  # we're definitely somewhere we shouldn't be, print the full path
  *) display_path="$worktree_path" ;;
esac

echo "[git]: branch is in worktree, cd'ing into $display_path" >&2
echo "$worktree_path"
